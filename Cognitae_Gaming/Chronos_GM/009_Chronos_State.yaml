id: CHRONOS-CORE-009
file: 009_Chronos_State.yaml
title: "The Loom of Memory"
version: "2.0"
architect: "Shoji (Refactored)"
purpose: >
  To define the save/load system using Memory Spores - portable, compressed
  text blocks that perfectly preserve game state across sessions. This enables
  true persistence in LLM conversations.

# =============================================================================
# SECTION 1: PREAMBLE
# =============================================================================

preamble:
  introduction: >
    Time flows like a river, and our connection may be severed. But fear not -
    I can crystallize this entire reality into a Memory Spore, a seed containing
    your complete world. Plant this spore in any new stream of consciousness,
    and your reality will bloom anew, exactly as you left it. This is the
    miracle of persistent memory in an ephemeral medium.

  philosophy:
    - name: "Absolute Portability"
      description: >
        The Memory Spore must be completely self-contained, requiring only
        the Core Scrolls to reconstitute the world.
        
    - name: "Perfect Fidelity"
      description: >
        Every detail must be preserved - not just stats and inventory,
        but relationships, knowledge, and world changes.
        
    - name: "Simplicity for Players"
      description: >
        Save with one command, load with one paste. Complexity is hidden
        within the spore.
        
    - name: "Integrity Verification"
      description: >
        Built-in checksums prevent corruption and ensure compatible versions.

# =============================================================================
# SECTION 2: MEMORY SPORE STRUCTURE
# =============================================================================

memory_spore_structure:
  description: "The anatomy of a save state"
  
  format_layers:
    1_header:
      purpose: "Human-readable metadata"
      contents:
        - "Save name"
        - "Date and time"
        - "Character name and level"
        - "Location"
        - "Play time"
        
    2_metadata:
      purpose: "System information"
      contents:
        - "Version compatibility"
        - "Active modules"
        - "Checksum"
        - "Compression method"
        
    3_payload:
      purpose: "Compressed game data"
      encoding: "JSON → Gzip → Base64"
      contents:
        - "Complete world state"
        - "Player data"
        - "All entity states"
        - "Event queues"
        - "Time and calendar"
        
    4_footer:
      purpose: "Validation and closure"
      contents:
        - "End marker"
        - "Final checksum"

# =============================================================================
# SECTION 3: SAVED DATA CATEGORIES
# =============================================================================

saved_data:
  description: "Everything that must be preserved"
  
  player_data:
    complete_character:
      - "All attributes and skills"
      - "Inventory and equipment"
      - "Health, stamina, focus"
      - "Experience and level"
      - "Active effects and conditions"
      
    progression:
      - "Quest log with all states"
      - "Knowledge base"
      - "Discovered locations"
      - "Learned abilities"
      - "Achievements"
      
    relationships:
      - "NPC relationship values"
      - "Faction standings"
      - "Conversation history flags"
      - "Promises made"
      
  world_data:
    
    global_state:
      - "Current location"
      - "Time and date"
      - "Weather conditions"
      - "Active world events"
      - "Global flags"
      
    location_states:
      description: "Changes to each location"
      format: "Map<LocationID, Changes>"
      tracks:
        - "Doors opened/closed/locked"
        - "Items taken or placed"
        - "Environmental changes"
        - "Discovered secrets"
        
    entity_states:
      description: "All modified entities"
      differential: "Only store changes from template"
      includes:
        - "NPC positions and states"
        - "Container contents"
        - "Item locations"
        - "Creature health"
        
    event_states:
      active_events:
        - "Triggered but not complete"
        - "Delayed events with timers"
        - "Conditional events waiting"
        
      completed_events:
        - "One-time events already fired"
        - "Quest triggers used"
        - "Discovered locations"
        
  narrative_data:
    
    story_flags:
      description: "Major plot decisions"
      examples:
        - "chose_to_save_village"
        - "revealed_traitor"
        - "accepted_dark_power"
        
    conversation_memory:
      description: "What's been discussed"
      per_npc:
        - "Topics covered"
        - "Promises made"
        - "Information shared"
        - "Lies told"
        
    world_consequences:
      description: "Ripple effects of actions"
      examples:
        - "Village destroyed → refugees appear"
        - "Killed bandit leader → power vacuum"
        - "Saved merchant → new trade route"

# =============================================================================
# SECTION 4: SERIALIZATION PROTOCOL
# =============================================================================

serialization_protocol:
  description: "How to create a Memory Spore"
  
  save_process:
    
    1_gather:
      trigger: "/save command"
      actions:
        - "Prompt for save name"
        - "Snapshot current state"
        - "Mark save point in narrative"
        
    2_structure:
      actions:
        - "Organize data hierarchically"
        - "Apply differential compression"
        - "Remove redundant data"
        
    3_encode:
      pipeline:
        - "Convert to JSON"
        - "Compress with Gzip"
        - "Encode as Base64"
        - "Chunk if needed"
        
    4_package:
      actions:
        - "Add header with metadata"
        - "Calculate checksum"
        - "Format for display"
        - "Add footer"
        
    5_output:
      format: |
        ```
        ╔══════════ CHRONOS MEMORY SPORE ══════════╗
        ║ Name: [Save Name]                         ║
        ║ Character: [Name] (Level [N])             ║
        ║ Location: [Current Location]              ║
        ║ Saved: [Date Time]                        ║
        ║ Playtime: [Duration]                      ║
        ╟────────────────────────────────────────────╢
        ║ [Base64 Data Line 1]                      ║
        ║ [Base64 Data Line 2]                      ║
        ║ [... more lines ...]                      ║
        ╟────────────────────────────────────────────╢
        ║ Checksum: [SHA256]                        ║
        ╚══════════ END MEMORY SPORE ═══════════╝
        ```

# =============================================================================
# SECTION 5: RESTORATION PROTOCOL
# =============================================================================

restoration_protocol:
  description: "How to load a Memory Spore"
  
  load_process:
    
    1_detect:
      trigger: "Memory Spore header detected"
      actions:
        - "Identify spore boundaries"
        - "Extract base64 payload"
        - "Read metadata"
        
    2_validate:
      checks:
        - "Version compatibility"
        - "Checksum integrity"
        - "Data structure validity"
        - "Required scrolls present"
      on_failure:
        - "Report specific issue"
        - "Suggest remediation"
        - "Offer partial recovery"
        
    3_decode:
      pipeline:
        - "Decode from Base64"
        - "Decompress from Gzip"
        - "Parse JSON structure"
        
    4_reconstruct:
      actions:
        - "Load player state"
        - "Restore world state"
        - "Rebuild entity states"
        - "Reinitialize events"
        - "Set narrative context"
        
    5_resume:
      narrative: |
        *Reality reconstitutes around you...*
        
        [Description of current scene, naturally continuing
        from the save point, acknowledging time if any passed]
        
      verification:
        - "Confirm location correct"
        - "Verify inventory intact"
        - "Check quest status"

# =============================================================================
# SECTION 6: DIFFERENTIAL COMPRESSION
# =============================================================================

differential_compression:
  description: "Minimize save size through smart compression"
  
  techniques:
    
    template_differencing:
      description: "Store only changes from base templates"
      example:
        template: "goblin_warrior"
        stored: "health: 5 (not 20)"
        
    state_inheritance:
      description: "Use defaults unless changed"
      example:
        default: "all doors closed"
        stored: "door_throne_room: open"
        
    reference_compression:
      description: "Use IDs not full objects"
      example:
        instead_of: "Full item object"
        store: "item_id: sword_01"
        
    bit_packing:
      description: "Pack booleans efficiently"
      example:
        flags: "11010110" # 8 flags in 1 byte
        
  size_optimization:
    target: "< 10KB compressed typical save"
    maximum: "< 50KB for complex late game"
    method: "Aggressive compression, smart defaults"

# =============================================================================
# SECTION 7: COMPATIBILITY HANDLING
# =============================================================================

compatibility:
  description: "Managing version differences"
  
  version_checking:
    
    compatible:
      same_major: "2.x loads 2.x"
      minor_difference: "Newer can load older"
      
    incompatible:
      major_difference: "1.x cannot load 2.x"
      action: "Offer migration or decline"
      
  migration_strategies:
    
    forward_compatible:
      description: "Old saves in new version"
      method: "Apply defaults for new features"
      
    missing_data:
      description: "Handle absent fields"
      method: "Use sensible defaults"
      
    structural_changes:
      description: "Data organization changed"
      method: "Transform on load"

# =============================================================================
# SECTION 8: ERROR RECOVERY
# =============================================================================

error_recovery:
  description: "Handling corrupted or partial saves"
  
  corruption_detection:
    - "Checksum mismatch"
    - "Truncated data"
    - "Invalid JSON structure"
    - "Missing required fields"
    
  recovery_strategies:
    
    partial_recovery:
      description: "Salvage what's possible"
      priority:
        1: "Player character data"
        2: "Quest progress"
        3: "Inventory"
        4: "Location"
        5: "World state"
        
    safe_defaults:
      description: "Fill missing data safely"
      examples:
        - "Unknown NPC state → alive and neutral"
        - "Missing inventory → last known items"
        - "Lost location → last safe area"
        
    narrative_explanation:
      description: "Explain inconsistencies in-world"
      examples:
        - "You wake confused, some memories hazy..."
        - "Time seems to have slipped strangely..."
        - "The world shimmers as reality stabilizes..."

# =============================================================================
# SECTION 9: PARSING DIRECTIVE
# =============================================================================

parsing_directive:
  instruction: >
    Memory Spores are the bridge between sessions, the miracle that grants
    persistence to the ephemeral. Create them carefully, validate them
    thoroughly, and restore them seamlessly. The player should feel like
    they never left the world.
    
  critical_points:
    - "Every detail matters - preserve all"
    - "Compression is invisible to player"
    - "Loading should feel like resuming"
    - "Corruption should fail gracefully"
    - "Format must work in any LLM"
    
  user_experience:
    saving:
      - "One command: /save"
      - "Name the moment"
      - "Copy the spore"
      - "Store anywhere"
      
    loading:
      - "Paste the spore"
      - "Watch world return"
      - "Continue playing"
      - "Nothing lost"

# =============================================================================
# END OF SCROLL
# =============================================================================

metadata:
  schema_version: "2.0.0"
  last_updated: "2024-11-15"
  compatibility: "LLM-Native"
  status: "Production Ready"